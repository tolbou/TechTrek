# AWS でインフラを構築しよう

## **概要**

早速クラウドにアプリをデプロイする環境を作成していきます！

まずはクラウド上に自分の作業スペースを作り、外部とのネットワークの設定を作っていきます。

これからの作業は root アカウントではなく、前の chapter で作成した IAM ユーザアカウントで進めてください。

## **リージョンの選択**

まずはクラウドサーバーを構築する、地域(リージョン)を指定します。

AWS は全世界で利用されており、各地域でホスティングされています。

画面右上のアカウント名の隣のプルダウンから「東京」を選んでください。

### **用語**

- ホスティング
  - サーバーを借りること、ここではサーバーを利用されている(借りられている)という意味になります

## **VPC**

VPC(Virtual Private Cloud)とは、AWS 上に作成できるプライベートなネットワークの領域です。

初期段階で各リージョンごとでデフォルトの VPC などが設定されていますので、今回はそちらを利用していきます。

コンソール画面の検索窓から「VPC」を検索し進んでください。

「VPC ダッシュボード」から確認してみましょう。

デフォルトで下記のようになっています。

!https://t.gyazo.com/teams/startup-technology/fd30ab7264a23118bf57c2bedb61178b.png

それぞれ Name タグが空になっているので、把握できるよう命名しておきましょう！

- VPC
  - runteq-vpc カーソルを当てると編集リンクが出てきます
    !https://t.gyazo.com/teams/startup-technology/0c5eb73b40befd27932de500208132e4.png
- サブネット
  - runteq-subnet-1a
  - runteq-subnet-1c※アベイラビリティゾーンごとで命名しています
- インターネットゲートウェイ
  - runteq-igw
- ルートテーブル
  - runteq-rt

### **用語**

- アベリラビリティゾーン(AZ)
  - これはサーバーを物理的に置いているデータセンターについて、各リージョンで地域毎にデータセンターを分けた集合の単位のこと

### ルートテーブルをサブネットに紐付け

デフォルトで設定されているルートテーブルをプライベートサブネットと紐付けます。

紐付けたいルートテーブルを選択し、「サブネットの関連付けを編集」から下記の２つのサブネットで紐付けます。

- runteq-subnet-1a
- runteq-subnet-1c

### セキュリティグループの作成

VPC 内の通信の許可/拒否の設定をするためにセキュリティグループを設定することができます。

今回はアプリケーションサーバーとデータベースの通信設定をしていきましょう

### **手順**

コンソール画面の検索窓から「VPC」を検索し進んでください。

左メニューの「セキュリティグループ」を選択し、右上「セキュリティグループを作成」をクリックします。

下記の設定で 2 つ作成します。

### **アプリサーバー接続用**

- 基本的な詳細
  - セキュリティグループ名：web-sg
  - 説明：web-sg
  - VPC：runteq-vpc
- インバウンドルール(2 つ)
  - 1 つ目
    - タイプ：HTTP
    - リソースタイプ(画面によってはタイプ)：Anywhere-IPv4
  - 2 つ目
    - タイプ：ssh
    - リソースタイプ(画面によってはタイプ)：Anywhere-IPv4
- アウトバウンドルール：そのまま
- タグ：なしで ok

※今回はクラウドサービスでアプリを動かすこと目的なので、HTTP のみの設定になっております

### **データベース接続用**

- 基本的な詳細
  - セキュリティグループ名：db-sg
  - 説明：db-sg
  - VPC：runteq-vpc
- インバウンドルール
  - タイプ：MYSQL/Aurora
  - ソース：カスタム web-sg(先ほど作成したセキュリティグループ)
- アウトバウンドルール：そのまま
- タグ：なしで ok

**データベースはアプリサーバーからのアクセスのみ許可したいので、インバウンドルールは web-sg のグループ ID を指定します**

AWS におけるネットワーク構築については以上となります。

次は RDS と EC2 インスタンスの作成に移ります。

### EC2(Elastic Compute Cloud)

EC2 はクラウドでサーバーの構築や運用ができるサービスです。

アプリを動かすサーバーを作っていきましょう！

コンソール画面の検索から「EC2」を検索して EC2 の画面へ進み、左メニュー内の「インスタンス」を選択してください。

右上の「インスタンスを起動」をクリックし、下記に従い設定していきます！

- Amazon マシンイメージ(AMI)
  - Amazon Linux 2 AMI (HVM) - Kernel 5.10, SSD Volume Type(64 ビット x86)
- インスタンスタイプの選択
  - t2.micro（ **無料対象枠と表示されているものを選択してください。** ）
- インスタンスの詳細の設定
  - インスタンス数：1
  - ネットワーク：runteq-vpc
  - サブネット：runteq-subnet-1a
- ストレージの追加：デフォルト
- タグの追加
  - キー：Name
  - 値：runteq-web
- セキュリティグループの設定
  - セキュリティグループの割り当て：既存
  - セキュリティグループ ID：web-sg

最後に「起動」をクリックすると、キーペアの作成が出るので、下記の設定でキーペアを作成してダウンロードをしてください。

こちらは EC2 にログインする際に必要なので、自分の PC に保存して、外部に出さないようにしましょう！

- 新しいキーペアの作成
- キーペアのタイプ：RSA
- キーペア名：runteq-key

### **注意点**

設定内容に関して、「インスタンスタイプの選択」で他のものを選択すると無料枠を利用せずに課金される可能性があるので、無料枠の対象になっているタイプを選択するように注意してください。

### **EC2 にログイン**

EC2 へログインするために、ダウンロードしたキーペアを移動させます。

ダウンロードした`runteq-key.pem`を`~/.ssh`に移動させてください。

移動完了後は、キーへのアクセス権限を設定します。キーがある階層に移動し、下記のコマンドを打ってください。

`$ chmod 400 runteq-key.pem`

最後に ssh ログインのコマンドを取得します。

EC2 のコンソール画面で作成したインスタンスを選択し、「接続」をクリックします。

「SSH クライアント」タブをクリックすると、接続のコマンドが出てきますので、ターミナルからそのコマンドを入力します。

ターミナルで下記のようになれば ok

```
[ec2-user@... ~]$

```

### **ElasticIP 紐づける**

先ほど作成した EC2 は停止して再度起動すると、パブリック IP が変わり、毎回 ssh ログイン時は不便になるので、固定の IP を紐付けます。

EC2 のダッシュボードの左メニューから「Elastic IP」に進み、右上の「Elastic IP アドレスの割り当て」から下記の設定で作成していきます。

- ネットワークボーダーグループ：ap-northeast-1a
- パブリック IP のアドレスプール：Amazon の IPv4 アドレスプール

作成後、今の ElasticIP を EC2 インスタンスに割り当てます。

右上の「アクション」から「ElasticIP アドレスの関連付け」に進み、先ほど作成した EC2 インスタンスに紐付け設定をしてください。

作成した EC2 の概要内に ElasticIP アドレスが表示されていれば ok です！

ElasticIP と紐付けたあとは EC2 との接続時に入力する ssh のコマンドが変わることがありますので適宜インスタンスに接続の項目を確認してください

### **注意点**

こちらのサービスは課金される可能性があるサービスです。

下記を満たしていれば無料で利用できます。

- ElasticIP が EC2 インスタンスに割り当てられている
- その EC2 が実行中（起動している）である

そのため上記の設定に従って進め、完了していれば問題ないです。

もし途中で作業を止める可能性がある場合は、時間があるときにこちらの項目から開始するようにしてください。

## **RDS(Relational Database Service)**

RDS はクラウドでリレーショナルデータベースを利用できるサービスです。

早速作成してきましょう！

### **DB サブネットグループの作成**

コンソール画面の検索窓から「RDS」を検索し進んでください。

まずは DB 用のサブネットグループを作成します。

左メニューの「サブネットグループ」を選択し、右上「DB サブネットグループを作成」をクリックします。

下記の設定で作成します。

- サブネットグループの詳細
  - 名前：runteq-subnetgroup
  - 説明：runteq-subnetgroup
  - VPC：runteq-vpc
- サブネットの追加
  - アベイラビリティゾーン：ap-northeast-1a, ap-northeast-1c
  - サブネット：runteq-subnet-1a, runteq-subnet-1c

### **RDS インスタンスの作成**

コンソール画面の検索窓から「RDS」を検索し進んでください。

左メニューの「データベース」を選択し、右上「データベースを作成」をクリックします。

下記の設定で作成します。

- データベースの作成方法：標準作成
- エンジンのオプション
  - エンジンのタイプ：MYSQL
  - エディション：MySQL Community
  - バージョン：8.0.xx(最新版)
- テンプレート：無料利用枠
- 設定
  - DB インスタンス識別子：デフォルト(database-1)
  - マスターユーザー名：デフォルト(admin)
  - マスターパスワード：任意のもの※ここでのユーザ名、パスワードは後ほどアプリ側に設定するので、控えておいてください。
- DB インスタンスクラス：デフォルト
- ストレージ：すべてデフォルト
- 可用性と耐久性：デフォルト
- 接続
  - VPC：runteq-vpc
  - サブネットグループ：runteq-subnetgroup
  - パブリックアクセス：なし
  - VPC セキュリティグループ：既存の選択 db-sg
  - アベイラビリティゾーン：ap-northeast-1a
  - データベースポート：3306
- データベース認証：パスワード認証
- 追加設定
  - 最初のデータベース名：runteq_db
  - その他はそのままで ok

### **注意点**

設定内容に関して、「テンプレート」設定で他のものを選択すると無料枠を利用せずに課金される可能性があるので、無料利用枠になっているタイプを選択するように注意してください。

また起動しなければ課金対象になることはないですが、停止中の場合は 7 日後に勝手に起動する仕様になっております。

そのため、次の chapter8 課題終了後は RDS を停止した後、削除してください。

## **最後に**

利用する AWS サービスの作成は完了しました。

最後にインスタンス内の環境構築をしていきましょう！
